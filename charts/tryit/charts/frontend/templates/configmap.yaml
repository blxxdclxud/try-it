apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  nginx.conf: |
    server {
        listen       80;
        listen  [::]:80;
        server_name  localhost;
        client_max_body_size {{ .Values.nginx.clientMaxBodySize | default "20M" }};

        gzip {{ .Values.nginx.gzip | default "on" }};
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        gzip_min_length 1000;
        gzip_proxied any;

        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            try_files $uri $uri/ /index.html;
            expires {{ .Values.nginx.staticCacheExpires | default "1d" }};
            add_header Cache-Control "public";
        }

        {{- range $path, $upstream := .Values.nginx.upstreams }}
        location {{ $path }} {
            proxy_pass                         http://{{ $upstream }};
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            {{- if hasSuffix "/ws" $path }}
            proxy_http_version                 1.1;
            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        "Upgrade";
            proxy_read_timeout                 {{ $.Values.nginx.websocketTimeout | default "3600s" }};
            proxy_send_timeout                 {{ $.Values.nginx.websocketTimeout | default "3600s" }};
            proxy_buffering                    off;
            {{- else }}

            proxy_connect_timeout              {{ $.Values.nginx.proxyConnectTimeout | default "75s" }};
            proxy_send_timeout                 {{ $.Values.nginx.proxySendTimeout | default "60s" }};
            proxy_read_timeout                 {{ $.Values.nginx.proxyReadTimeout | default "60s" }};
            proxy_buffer_size                  {{ $.Values.nginx.proxyBufferSize | default "16k" }};
            proxy_buffers                      {{ $.Values.nginx.proxyBuffers | default "4 32k" }};
            {{- end }}
        }
        {{- end }}

        location ~ ^/api/.*/metrics$ {
            deny all;
            return 404;
        }

        location /healthz {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
